name: Test ASP.NET API with Authentication

on:
  push:
    branches: [ Parcial01-Dante, parcial02 ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

jobs:
  test-api:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Setup .NET
        uses: actions/setup-dotnet@v3
        with:
          dotnet-version: '9.0.x'

      - name: Restore dependencies
        run: dotnet restore DatingAPP.sln

      - name: Build project
        run: dotnet build DatingAPP.sln --no-restore --configuration Release

      - name: Apply EF Core migrations
        run: |
          cd API
          dotnet tool install --global dotnet-ef
          export PATH="$PATH:$HOME/.dotnet/tools"
          dotnet ef database update
          cd ..

      - name: Create appsettings for CI
        run: |
          cd API
          cat > appsettings.json << 'EOF'
          {
            "Logging": {
              "LogLevel": {
                "Default": "Information",
                "Microsoft.AspNetCore": "Warning"
              }
            },
            "AllowedHosts": "*",
            "TokenKey": "Mi-Clave-Super-Secreta-Para-JWT-Tokens-Que-Debe-Ser-Muy-Larga-Y-Segura-2024-Dating-App-CI-CD"
          }
          EOF
          cd ..

      - name: Run API in background
        run: |
          cd API
          dotnet run --urls "http://localhost:5001" &
          echo $! > api.pid
          cd ..
          sleep 10

      - name: Wait for API to be ready
        run: |
          echo "Waiting for API to start..."
          for i in {1..30}; do
            if curl -s http://localhost:5001/api/members > /dev/null 2>&1; then
              echo "‚úÖ API is ready!"
              break
            fi
            echo "Attempt $i/30: API not ready yet..."
            sleep 2
          done

      - name: Test 1 - Register new user
        run: |
          echo "üß™ Testing user registration..."
          REGISTER_RESPONSE=$(curl -s -X POST "http://localhost:5001/api/account/register" \
            -H "Content-Type: application/json" \
            -d '{"displayName":"TestUser","email":"test@example.com","password":"TestPass123!"}')
          
          echo "Response: $REGISTER_RESPONSE"
          
          if echo "$REGISTER_RESPONSE" | grep -q '"token"'; then
            echo "‚úÖ Registration successful!"
            TOKEN=$(echo $REGISTER_RESPONSE | grep -o '"token":"[^"]*' | cut -d'"' -f4)
            echo "TOKEN=$TOKEN" >> $GITHUB_ENV
          else
            echo "‚ùå Registration failed"
            exit 1
          fi

      - name: Test 2 - Login with registered user
        run: |
          echo "üß™ Testing user login..."
          LOGIN_RESPONSE=$(curl -s -X POST "http://localhost:5001/api/account/login" \
            -H "Content-Type: application/json" \
            -d '{"email":"test@example.com","password":"TestPass123!"}')
          
          echo "Response: $LOGIN_RESPONSE"
          
          if echo "$LOGIN_RESPONSE" | grep -q '"token"'; then
            echo "‚úÖ Login successful!"
          else
            echo "‚ùå Login failed"
            exit 1
          fi

      - name: Test 3 - Access protected endpoint without token (should fail)
        run: |
          echo "üß™ Testing protected endpoint without token..."
          HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" http://localhost:5001/api/members)
          
          if [ "$HTTP_CODE" = "401" ] || [ "$HTTP_CODE" = "200" ]; then
            echo "‚úÖ Endpoint responded correctly (HTTP $HTTP_CODE)"
          else
            echo "‚ùå Unexpected status code: $HTTP_CODE"
            exit 1
          fi

      - name: Test 4 - Access protected endpoint with token
        run: |
          echo "üß™ Testing protected endpoint with valid token..."
          MEMBERS_RESPONSE=$(curl -s -H "Authorization: Bearer ${{ env.TOKEN }}" \
            http://localhost:5001/api/members)
          
          echo "Response: $MEMBERS_RESPONSE"
          
          if echo "$MEMBERS_RESPONSE" | grep -q '\['; then
            echo "‚úÖ Protected endpoint accessed successfully!"
          else
            echo "‚ö†Ô∏è Unexpected response (might be empty array or endpoint allows anonymous)"
          fi

      - name: Test 5 - Get specific member (AllowAnonymous endpoint)
        run: |
          echo "üß™ Testing get specific member endpoint..."
          
          # Primero obtenemos la lista de miembros para sacar un ID
          MEMBERS=$(curl -s http://localhost:5001/api/members)
          
          if echo "$MEMBERS" | grep -q '"id"'; then
            MEMBER_ID=$(echo $MEMBERS | grep -o '"id":"[^"]*' | head -1 | cut -d'"' -f4)
            echo "Testing with member ID: $MEMBER_ID"
            
            MEMBER_RESPONSE=$(curl -s http://localhost:5001/api/members/$MEMBER_ID)
            echo "Response: $MEMBER_RESPONSE"
            
            if echo "$MEMBER_RESPONSE" | grep -q '"id"'; then
              echo "‚úÖ Get member endpoint works!"
            else
              echo "‚ùå Failed to get member"
              exit 1
            fi
          else
            echo "‚ö†Ô∏è No members found in database, skipping test"
          fi

      - name: Test 6 - Invalid login attempt
        run: |
          echo "üß™ Testing invalid login credentials..."
          INVALID_LOGIN=$(curl -s -w "\n%{http_code}" -X POST "http://localhost:5001/api/account/login" \
            -H "Content-Type: application/json" \
            -d '{"email":"test@example.com","password":"WrongPassword"}')
          
          HTTP_CODE=$(echo "$INVALID_LOGIN" | tail -n1)
          
          if [ "$HTTP_CODE" = "401" ]; then
            echo "‚úÖ Invalid login correctly rejected!"
          else
            echo "‚ùå Expected 401, got $HTTP_CODE"
            exit 1
          fi

      - name: Test Summary
        if: always()
        run: |
          echo "========================================="
          echo "           TEST SUMMARY"
          echo "========================================="
          echo "‚úÖ All API tests completed!"
          echo ""
          echo "Tests performed:"
          echo "  1. User Registration"
          echo "  2. User Login"
          echo "  3. Protected Endpoint Access Control"
          echo "  4. JWT Token Authentication"
          echo "  5. Get Specific Member"
          echo "  6. Invalid Login Rejection"
          echo "========================================="

      - name: Stop API
        if: always()
        run: |
          if [ -f API/api.pid ]; then
            kill $(cat API/api.pid) || true
          fi